<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <title>SmartLux Night Light - User Access Control</title>
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css" />
  <link href="https://fonts.googleapis.com/css?family=Nunito:200,300,400,600,700,800,900" rel="stylesheet" />
  <link href="css/sb-admin-2.min.css" rel="stylesheet" />
  <link href="vendor/datatables/dataTables.bootstrap4.min.css" rel="stylesheet" />
  <style>
    #accordionSidebar.bg-gradient-primary { background: #8963BA !important; }
    .sidebar-logo-img { width: 60px; height: auto; margin: 15px 0 0 0; }
    .sidebar-brand-text { font-size: 12px; margin-left: 0; margin-right: 18px; }
    .profile-img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; }

    /* Loading overlay + skeleton row styles (appended) */
    .users-loading-overlay {
      position: absolute;
      inset: 0;
      display:flex;
      align-items:center;
      justify-content:center;
      background: rgba(255,255,255,0.6);
      z-index: 999;
    }
    .users-spinner {
      width:48px;
      height:48px;
      border:4px solid rgba(0,0,0,0.1);
      border-top-color: rgba(0,0,0,0.6);
      border-radius:50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Simple table skeleton row */
    .users-skeleton-row td {
      background: linear-gradient(90deg, #f3f3f3 25%, #ececec 50%, #f3f3f3 75%);
      background-size: 200% 100%;
      animation: skeleton-loading 1.2s linear infinite;
      height: 48px;
    }
    @keyframes skeleton-loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }
  </style>
</head>
<body id="page-top">
  <div id="wrapper">
    <ul class="navbar-nav bg-gradient-primary sidebar sidebar-dark accordion" id="accordionSidebar">
      <a class="sidebar-brand d-flex align-items-center justify-content-center" href="dashboardadmin.html">
        <img src="img/LOGONT.png" alt="Logo" class="sidebar-logo-img" />
        <div class="sidebar-brand-text" style="font-size:15px;">SMARTLUX NIGHT LIGHT</div>
      </a>
      <!-- Divider -->
            <hr class="sidebar-divider my-0" />
            <!-- Nav Item - Dashboard -->
            <li class="nav-item">
                <a class="nav-link" href="dashboardadmin.html">
                    <i class="fas fa-fw fa-tachometer-alt"></i>
                    <span>Dashboard</span></a
                >
            </li>
			
			
						
			<hr class="sidebar-divider my-0" />
			 <!-- Nav Item - Control -->
			<li class="nav-item">
				<a class="nav-link" href="temperatureAdmin.html">
					<i class="fas fa-fw fa-solid fa-temperature-low"></i>
					<span>Temperature</span>
				</a>
			</li>
			<hr class="sidebar-divider my-0" />
			 <!-- Nav Item - Control -->
			<li class="nav-item">
				<a class="nav-link" href="humidityAdmin.html">
					<i class="fas fa-fw fa-solid fa-tint"></i>
					<span>Humidity</span>
				</a>
			</li>
			<hr class="sidebar-divider my-0" />
			 <!-- Nav Item - Control -->
			<li class="nav-item">
				<a class="nav-link" href="motionAdmin.html">
					<i class="fas fa-fw fa-solid fa-running"></i>
					<span>Motion</span>
				</a>
			</li>
			<hr class="sidebar-divider my-0" />
			 <!-- Nav Item - Control -->
			<li class="nav-item">
				<a class="nav-link" href="lightAdmin.html">
					<i class="fas fa-fw fa-solid fa-lightbulb"></i>
					<span>Light</span>
				</a>
			</li>
			
			<!-- USER ACCESS CONTROL -->
            <hr class="sidebar-divider my-0" />
            <!-- Nav Item - Dashboard -->
            <li class="nav-item active">
				<a class="nav-link" href="users.html">
					<!-- <img src="img/iconUsers.png" alt="Users Icon" style="width:20px; height:20px; margin-right:8px;"> -->
					<i class="fas fa-users"></i>
					<span>Manage Users</span>
				</a>
			</li>
			
			
			<hr class="sidebar-divider my-0" />
    <!-- Nav Item - Control Admin -->
    <li class="nav-item">
      <a class="nav-link" href="controladmin.html">
        <i class="fas fa-fw fa-cogs"></i>
        <span>Light Control</span>
      </a>
    </li>


      
      <hr class="sidebar-divider d-none d-md-block" />
      <div class="text-center d-none d-md-inline">
        <button class="rounded-circle border-0" id="sidebarToggle"></button>
      </div>
    </ul>

    <div id="content-wrapper" class="d-flex flex-column">
      <div id="content">
        <nav class="navbar navbar-expand navbar-light bg-white topbar mb-4 static-top shadow">
          <button id="sidebarToggleTop" class="btn btn-link d-md-none rounded-circle mr-3">
            <i class="fa fa-bars"></i>
          </button>
          <ul class="navbar-nav ml-auto">
            <li class="nav-item dropdown no-arrow">
              <a class="nav-link dropdown-toggle" href="#" id="userDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                <span id="topbarUsername" class="mr-2 d-none d-lg-inline text-gray-600 small">Admin</span>
                <img id="topbarAvatar" class="img-profile rounded-circle" src="img/undraw_profile.svg" />
              </a>
              <div class="dropdown-menu dropdown-menu-right shadow animated--grow-in" aria-labelledby="userDropdown">
                <a class="dropdown-item" href="profile.html">
                  <i class="fas fa-user fa-sm fa-fw mr-2 text-gray-400"></i>Profile
                </a>
                <div class="dropdown-divider"></div>
                <a class="dropdown-item" href="#" data-toggle="modal" data-target="#logoutModal">
                  <i class="fas fa-sign-out-alt fa-sm fa-fw mr-2 text-gray-400"></i>Logout
                </a>
              </div>
            </li>
          </ul>
        </nav>

        <div class="container-fluid">
          <h1 class="h3 mb-4 text-gray-800">User Management</h1>
          <button class="btn btn-primary mb-3" data-toggle="modal" data-target="#addUserModal">
          Add User
          </button>

          <div class="table-responsive">
            <table class="table table-bordered" id="usersTable" width="100%" cellspacing="0">
              <thead>
                <tr>
                  <th>Profile</th>
                  <th>Username</th>
                  <th>Role</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add User Modal -->
  <div class="modal fade" id="addUserModal" tabindex="-1" role="dialog" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="formAddUser" novalidate>
          <div class="modal-header">
            <h5 class="modal-title" id="addUserModalLabel">Add New User</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">&times;</span>
            </button>
          </div>
          <div class="modal-body">
            <div class="form-group"><label for="addUsername">Username</label><input type="text" class="form-control" id="addUsername" required /></div>
            <div class="form-group"><label for="addFirstName">First Name</label><input type="text" class="form-control" id="addFirstName" required /></div>
            <div class="form-group"><label for="addLastName">Last Name</label><input type="text" class="form-control" id="addLastName" required /></div>
            <div class="form-group"><label for="addEmail">Email</label><input type="email" class="form-control" id="addEmail" required /></div>
            <div class="form-group"><label for="addRole">Role</label>
              <select class="form-control" id="addRole" required>
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="form-group"><label for="addPassword">Password</label><input type="password" class="form-control" id="addPassword" autocomplete="new-password" required /></div>
            <div class="form-group"><label for="addConfirmPassword">Confirm Password</label><input type="password" class="form-control" id="addConfirmPassword" autocomplete="new-password" required /></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Add User</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div class="modal fade" id="editUserModal" tabindex="-1" role="dialog" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <form id="formEditUser" novalidate>
          <div class="modal-header">
            <h5 class="modal-title" id="editUserModalLabel">Edit User</h5>
            <button type="button" class="close" data-dismiss="modal" aria-label="Close">
              <span aria-hidden="true">×</span>
            </button>
          </div>
          <div class="modal-body">
            <input type="hidden" id="editUserId" />
            <div class="form-group"><label for="editUsername">Username</label><input type="text" class="form-control" id="editUsername" required /></div>
            <div class="form-group"><label for="editFirstName">First Name</label><input type="text" class="form-control" id="editFirstName" required /></div>
            <div class="form-group"><label for="editLastName">Last Name</label><input type="text" class="form-control" id="editLastName" required /></div>
            <div class="form-group"><label for="editEmail">Email</label><input type="email" class="form-control" id="editEmail" disabled /></div>
            <div class="form-group"><label for="editRole">Role</label>
              <select class="form-control" id="editRole" required>
                <option value="user">User</option>
                <option value="admin">Admin</option>
              </select>
            </div>
            <div class="form-group"><label for="editPassword">Password</label><input type="password" class="form-control" id="editPassword" autocomplete="new-password" /></div>
            <div class="form-group"><label for="editConfirmPassword">Confirm Password</label><input type="password" class="form-control" id="editConfirmPassword" autocomplete="new-password" /></div>
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Modals (Logout, etc.) remain unchanged -->
  <!-- Logout Modal -->
  <div class="modal fade" id="logoutModal" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
          <button class="close" type="button" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">×</span>
          </button>
        </div>
        <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
        <div class="modal-footer">
          <button class="btn btn-secondary" type="button" data-dismiss="modal">Cancel</button>
          <a class="btn btn-primary" href="login.html">Logout</a>
        </div>
      </div>
    </div>
  </div>


  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
  <script src="js/sb-admin-2.min.js"></script>
  <script src="vendor/datatables/jquery.dataTables.min.js"></script>
  <script src="vendor/datatables/dataTables.bootstrap4.min.js"></script>

  <script type="module">
  import { auth, db } from './firebase-config.js';
  import {
    collection, doc, getDocs, updateDoc, deleteDoc, getDoc,
  } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';
  import { onAuthStateChanged, updateEmail } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';

 // FIX alert popups
 $(document).ready(function () {
  // Disable DataTables alert popups
  $.fn.dataTable.ext.errMode = 'none';

  // Initialize DataTable only once
  const table = $('#usersTable').DataTable({
    columnDefs: [
      { orderable: false, targets: 3 },
      { targets: '_all', defaultContent: '' }
    ]
  });


    // ----- START: improved loadUsers with cache + skeleton -----
    const USERS_CACHE_KEY = 'users_cache_v1';
    const CACHE_TTL = 5 * 60 * 1000; // 5 minutes

    // Helper: render rows into DataTable
    function renderRowsToTable(users) {
      const rows = [];
      users.forEach((user) => {
        const profileImg = `<img src="${user.avatarUrl || 'img/undraw_profile.svg'}" alt="${user.username || ''}" class="profile-img" loading="lazy" />`;
        const usernameCell = `<span class="text-primary" style="cursor:pointer;" data-id="${user.id}">${user.username || ''}</span>`;
        const deleteBtn = `<button class="btn btn-danger btn-sm delete-btn" data-id="${user.id}">Delete</button>`;
        rows.push([profileImg, usernameCell, user.role || '', deleteBtn]);
      });

      table.clear();
      if (rows.length) {
        table.rows.add(rows).draw();
      } else {
        // keep table empty but redraw to remove skeletons
        table.draw();
      }
    }

    // Small UI helpers
    function showLoadingOverlay() {
      // avoid duplicate
      if ($('.users-loading-overlay').length) return;
      const overlay = $(`
        <div class="users-loading-overlay">
          <div class="users-spinner" role="status" aria-hidden="true"></div>
        </div>
      `);
      // place overlay above the table wrapper
      $('.table-responsive').css('position', 'relative').append(overlay);
    }
    function hideLoadingOverlay() {
      $('.users-loading-overlay').remove();
    }
    function showSkeletonRows(count = 5) {
      table.clear();
      const skeletons = [];
      for (let i = 0; i < count; i++) {
        skeletons.push([`<div style="width:48px;height:48px;border-radius:50%;background:#eee;"></div>`,
                        `<div style="width:150px;height:20px;background:#eee;"></div>`,
                        `<div style="width:100px;height:30px;background:#eee;"></div>`]);
      }
      // Use raw html cells but add a row class to animate with CSS
      table.rows.add(skeletons).draw();
      // Add skeleton style class to table body rows
      $('#usersTable tbody tr').addClass('users-skeleton-row');
    }

    // Save cache
    function saveUsersCache(users) {
      try {
        const toSave = { ts: Date.now(), users };
        localStorage.setItem(USERS_CACHE_KEY, JSON.stringify(toSave));
      } catch (err) {
        // ignore localStorage errors
        console.warn('Could not save users cache:', err);
      }
    }

    // Read cache
    function readUsersCache() {
      try {
        const raw = localStorage.getItem(USERS_CACHE_KEY);
        if (!raw) return null;
        const parsed = JSON.parse(raw);
        return parsed;
      } catch (err) {
        return null;
      }
    }

    // Fetch fresh from Firestore, update table and cache
    async function fetchFreshUsersAndUpdate() {
      try {
        const usersCol = collection(db, 'users');
        const snapshot = await getDocs(usersCol);
        const users = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        // update UI only if data changed length or timestamp — simple equality check
        renderRowsToTable(users);
        saveUsersCache(users);
      } catch (err) {
        console.error('Error fetching fresh users:', err);
      } finally {
        hideLoadingOverlay();
        // remove skeleton class if present
        $('#usersTable tbody tr').removeClass('users-skeleton-row');
      }
    }

    async function loadUsers() {
      // 1) Try cache first (stale-while-revalidate)
      const cache = readUsersCache();
      if (cache && (Date.now() - cache.ts) < CACHE_TTL && Array.isArray(cache.users)) {
        // render cached immediately
        renderRowsToTable(cache.users);
        // background refresh but do show a small overlay so user knows updating
        showLoadingOverlay();
        fetchFreshUsersAndUpdate();
        return;
      }

      // 2) No valid cache -> show skeleton + overlay while fetching
      showSkeletonRows(6);
      showLoadingOverlay();

      try {
        const usersCol = collection(db, 'users');
        const snapshot = await getDocs(usersCol);
        const users = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
        renderRowsToTable(users);
        saveUsersCache(users);
      } catch (err) {
        console.error('Error loading users from Firestore:', err);
        // if we have stale cache, show it as fallback
        if (cache && Array.isArray(cache.users)) {
          renderRowsToTable(cache.users);
          alert('Showing cached users (network error).');
        } else {
          // remove skeleton and show message row
          table.clear();
          table.row.add([ '', 'No users available (and no cache).', '' ]).draw();
          alert('Failed to load users. See console for details.');
        }
      } finally {
        hideLoadingOverlay();
        $('#usersTable tbody tr').removeClass('users-skeleton-row');
      }
    }

    // Call the improved loader
    loadUsers();
    // ----- END: improved loadUsers with cache + skeleton -----

    $('#formAddUser').submit(async function (e) {
      e.preventDefault();
      const form = this;
      const username = $('#addUsername').val().trim();
      const firstName = $('#addFirstName').val().trim();
      const lastName = $('#addLastName').val().trim();
      const email = $('#addEmail').val().trim();
      const role = $('#addRole').val();
      const password = $('#addPassword').val();
      const confirmPassword = $('#addConfirmPassword').val();

      if (!username || !firstName || !lastName || !email || !password || !confirmPassword) {
        alert('Please fill out all fields.');
        console.error('Add User validation failed: Missing fields.');
        return;
      }
      if (password !== confirmPassword) {
        alert('Passwords do not match.');
        console.error('Add User validation failed: Passwords do not match.');
        return;
      }

      try {
        const response = await fetch('http://localhost:3000/api/createUser', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, firstName, lastName, email, role, password }),
        });
        const data = await response.json();
        if (!response.ok) {
          console.error('Add User API error:', data.error);
          throw new Error(data.error || 'Failed to create user.');
        }
        alert('User created successfully!');
        $('#addUserModal').modal('hide');
        form.reset();
        loadUsers();
      } catch (err) {
        console.error('Add user failed:', err);
        alert('Add user failed: ' + err.message);
      }
    });

$('#formEditUser').submit(async function (e) {
  e.preventDefault();
  const userId = $('#editUserId').val();
  const username = $('#editUsername').val().trim();
  const firstName = $('#editFirstName').val().trim();
  const lastName = $('#editLastName').val().trim();
  const email = $('#editEmail').val().trim();
  const role = $('#editRole').val();
  const password = $('#editPassword').val();
  const confirmPassword = $('#editConfirmPassword').val();

  if (!username || !firstName || !lastName || !email) {
    alert('Please fill out all required fields.');
    console.error('Edit User validation failed: Missing required fields.');
    return;
  }
  if ((password || confirmPassword) && password !== confirmPassword) {
    alert('Passwords do not match.');
    console.error('Edit User validation failed: Passwords do not match.');
    return;
  }

  try {
    // Call backend to update Firebase Auth (email/displayName) AND Firestore user doc
    const response = await fetch('http://localhost:3000/api/updateUser', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        uid: userId,
        email,
        username,
        firstName,
        lastName,
        role,
      }),
    });

    const result = await response.json();
    if (!response.ok) {
      console.error('Update user API error:', result.error || result);
      throw new Error(result.error || 'Failed to update user.');
    }

    // If password supplied, call password endpoint (unchanged)
    if (password) {
      try {
        const pwResp = await fetch('http://localhost:3000/api/updateUserPassword', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uid: userId, newPassword: password }),
        });
        const pwResult = await pwResp.json();
        if (!pwResp.ok) {
          console.error('Password update API error:', pwResult.error);
          throw new Error(pwResult.error || 'Password update failed.');
        }
        console.log('Password updated successfully for user:', userId);
      } catch (err) {
        console.error('Password update failed:', err);
        alert('Password update failed: ' + err.message);
        return;
      }
    }

    $('#editUserModal').modal('hide');
    // If the currently signed-in admin updated their own email, local client auth state may be stale.
    // We attempt to update the client-side auth user if possible; if it fails, user may need to re-login.
    const currentUser = auth.currentUser;
    if (currentUser && currentUser.uid === userId && currentUser.email !== email) {
      try {
        // This may require recent login; catch errors but continue.
        await updateEmail(currentUser, email);
        console.log('Local auth email updated for currently signed-in user.');
      } catch (err) {
        console.warn('Could not update client-side auth email; user may need to re-login.', err);
        // don't block UI - just let admin know
        alert('Email was updated on the server. You may need to sign out and sign in again for the change to fully take effect.');
      }
    }

    loadUsers();
  } catch (error) {
    console.error('Edit user failed:', error);
    alert('Edit user failed: ' + error.message);
  }
});


$('#usersTable tbody').on('click', 'button.delete-btn', async function () {
  const userId = $(this).data('id');
  if (!userId) return;

  if (confirm('Are you sure you want to delete this user? This will remove the account from both Auth and Firestore.')) {
    try {
      const resp = await fetch('http://localhost:3000/api/deleteUser', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ uid: userId }),
      });

      const result = await resp.json();
      if (!resp.ok) {
        console.error('Delete user API error:', result.error || result);
        throw new Error(result.error || 'Delete failed.');
      }

      alert('User deleted successfully.');
      loadUsers();
    } catch (error) {
      console.error('Delete failed:', error);
      alert('Delete failed: ' + error.message);
    }
  }
});


    $('#usersTable tbody').on('click', 'span.text-primary', function () {
      const userId = $(this).data('id');
      openEditModal(userId);
    });

    async function openEditModal(userId) {
      try {
        const userDocRef = doc(db, 'users', userId);
        const docSnap = await getDoc(userDocRef);
        if (!docSnap.exists()) {
          alert('User does not exist.');
          console.error('Open edit modal error: User does not exist - UID:', userId);
          return;
        }
        const user = docSnap.data();
        $('#editUserId').val(userId);
        $('#editUsername').val(user.username);
        $('#editFirstName').val(user.firstName);
        $('#editLastName').val(user.lastName);
        $('#editEmail').val(user.email);
        $('#editRole').val(user.role || 'user');
        $('#editPassword').val('');
        $('#editConfirmPassword').val('');
        $('#editUserModal').modal('show');
      } catch (error) {
        console.error('Open edit modal failed:', error);
        alert('Failed to open edit modal: ' + error.message);
      }
    }

	onAuthStateChanged(auth, async (user) => {
	  if (user) {
		// Prefer the username stored in Firestore users collection; fallback to displayName then email prefix.
		let displayName = 'User';
		try {
		  const userDocRef = doc(db, 'users', user.uid);
		  const userSnap = await getDoc(userDocRef);
		  if (userSnap.exists() && userSnap.data().username) {
			displayName = userSnap.data().username;
		  } else if (user.displayName) {
			displayName = user.displayName;
		  } else if (user.email) {
			displayName = user.email.split('@')[0];
		  }
		} catch (err) {
		  console.warn('Failed to load Firestore user doc for topbar username:', err);
		  displayName = user.displayName || (user.email ? user.email.split('@')[0] : 'User');
		}

		$('#topbarUsername').text(displayName);
		$('#topbarAvatar').attr('src', user.photoURL || 'img/undraw_profile.svg');
	  } else {
		$('#topbarUsername').text('Guest');
		$('#topbarAvatar').attr('src', 'img/undraw_profile.svg');
	  }
	});
  });
  
  
</script>

</body>
</html>
