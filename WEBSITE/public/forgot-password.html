<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
  <meta name="description" content="" />
  <meta name="author" content="" />
  <title>SmartLux Night Light - Forgot Password</title>
  <!-- Custom fonts for this template-->
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css" />
  <link
    href="https://fonts.googleapis.com/css?family=Nunito:200,200i,300,300i,400,400i,600,600i,700,700i,800,800i,900,900i"
    rel="stylesheet"
  />
  <!-- Custom styles for this template-->
  <link href="css/sb-admin-2.min.css" rel="stylesheet" />
  <style>
    body {
      background-color: #4a69bd; /* Blue background consistent with other pages */
    }
    .card {
      border-radius: 12px;
      box-shadow: 0 0 20px rgba(0,0,0,0.15);
      max-width: 900px;
      margin: 3rem auto;
    }
    .forgot-logo {
      max-width: 100%;
      height: auto;
      display: block;
      margin: auto;
    }
    /* Desktop: logo left side */
    .logo-col {
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: #215D6E;
      padding: 40px;
      border-top-left-radius: 12px;
      border-bottom-left-radius: 12px;
    }
    /* Mobile: logo on top with margin-bottom */
    @media (max-width: 767.98px) {
      .logo-col {
        padding: 30px 0;
        border-radius: 12px 12px 0 0;
      }
      .content-col {
        padding: 30px 20px 40px;
        border-radius: 0 0 12px 12px;
      }
      .card {
        border-radius: 12px;
      }
    }
  </style>
</head>
<body>
  <div class="container my-5">
    <div class="card mx-auto">
      <div class="row no-gutters">
        <div class="col-lg-6 logo-col d-none d-lg-flex">
          <!-- Desktop logo column -->
          <img src="img/LOGO.png" alt="SMARTLUX NIGHT LIGHT Logo" class="forgot-logo" />
        </div>
        <div class="col-lg-6 content-col p-5">
          <!-- Mobile logo on top for smaller screens -->
          <div class="d-block d-lg-none mb-4 text-center">
            <img src="img/LOGO.png" alt="SMARTLUX NIGHT LIGHT Logo" class="forgot-logo" style="max-width:200px;" />
          </div>
          <div class="text-center">
            <h1 class="h4 text-gray-900 mb-2">Forgot Your Password?</h1>
            <p class="mb-4">
              We get it, stuff happens. Just enter your email address below and we'll send you a
              link to reset your password!
            </p>
          </div>
          <form class="user" id="forgotPasswordForm" novalidate>
            <div class="form-group">
              <input
                type="email"
                class="form-control form-control-user"
                id="inputEmail"
                aria-describedby="emailHelp"
                placeholder="Enter Email Address..."
                required
              />
            </div>
            <button
              type="submit"
              class="btn btn-primary btn-user btn-block"
              aria-label="Reset Password"
            >
              Reset Password
            </button>
          </form>
          <hr />
          <div class="text-center">
            <a class="small" href="register.html">Create an Account!</a>
          </div>
          <div class="text-center">
            <a class="small" href="login.html">Already have an account? Login!</a>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="text-center">
    <h2 class="text-primary font-weight-bold mb-3">SMARTLUX NIGHT LIGHT</h2>
  </div>
  <!-- Firebase and your scripts -->
<script type="module">
  import { auth } from './firebase-config.js'; // ensure correct relative path
  import { sendPasswordResetEmail } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';

  const form = document.getElementById('forgotPasswordForm');
  const emailInput = document.getElementById('inputEmail');

  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;

  function showMessage(msg, isError = false) {
    // Simple UX: swap with Bootstrap alert if you want nicer styling
    if (isError) {
      alert('Error: ' + msg);
    } else {
      alert(msg);
    }
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const email = emailInput.value.trim();
    if (!email) {
      showMessage('Please enter your email address.', true);
      emailInput.focus();
      return;
    }
    if (!emailRegex.test(email)) {
      showMessage('Please enter a valid email address.', true);
      emailInput.focus();
      return;
    }

    try {
      // 1) Server-side validation (Admin SDK)
      const checkResp = await fetch('http://localhost:3000/api/checkUserByEmail', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ email })
      });
      const checkJson = await checkResp.json();
      console.log('checkUserByEmail:', checkJson);

      // Option: privacy-preserving default
      // showMessage("If that email is registered with us, you'll receive password reset instructions shortly.");
      // return;

      // Explicit flow (since you want validation)
      if (!checkJson.ok) {
        // server says user not found or other issue
        if (checkJson.code === 'user-not-found') {
          showMessage('No user found with this email address.', true);
        } else {
          showMessage('Unable to verify user. Please try again later.', true);
        }
        return;
      }

      // server found user â€” ensure password provider present
      if (!checkJson.providers || !checkJson.providers.includes('password')) {
        showMessage(
          'This account signs in with an external provider (' +
            (checkJson.providers || []).join(', ') +
            '). Password reset is not available.',
          true
        );
        return;
      }

      // 2) Ask Firebase client SDK to send the reset email (uses Firebase templates & delivery)
      try {
        await sendPasswordResetEmail(auth, email);
        showMessage('Password reset email sent. Check your inbox (and spam folder).');
        form.reset();
        return;
      } catch (clientErr) {
        console.error('sendPasswordResetEmail client error:', clientErr);
        // Unexpected mismatch: admin finds user but client failed to send.
        // Fallback: ask server to generate & send the link (server uses Admin SDK & SMTP)
        try {
          const fallbackResp = await fetch('http://localhost:3000/api/sendResetLink', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email, sendEmail: true }) // server should email the link
          });
          const fallbackJson = await fallbackResp.json();
          console.log('sendResetLink fallback:', fallbackJson);
          // Be privacy-preserving: always show same message
          showMessage("If that email is registered with us, you'll receive password reset instructions shortly.");
          form.reset();
          return;
        } catch (fallbackErr) {
          console.error('Fallback generate/send link error:', fallbackErr);
          showMessage('Unable to send reset email right now. Please try again later.', true);
          return;
        }
      }
    } catch (err) {
      console.error('Forgot password flow error:', err);
      showMessage('An error occurred. Please try again later.', true);
    }
  });
</script>



  <!-- Bootstrap core JavaScript-->
  <script src="vendor/jquery/jquery.min.js"></script>
  <script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>
  <!-- Core plugin JavaScript-->
  <script src="vendor/jquery-easing/jquery.easing.min.js"></script>
  <!-- Custom scripts for all pages-->
  <script src="js/sb-admin-2.min.js"></script>
</body>
</html>
