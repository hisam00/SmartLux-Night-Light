<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Profile Setup - SMARTLUX NIGHT LIGHT</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <link href="vendor/fontawesome-free/css/all.min.css" rel="stylesheet" />
  <link href="css/sb-admin-2.min.css" rel="stylesheet" />
  <style>
    body {
      background: linear-gradient(120deg, #2096ff 0%, #05ffa3 100%);
      font-family: 'Poppins', sans-serif;
    }
    .container-profile {
      max-width: 480px;
      margin: 3rem auto;
      background: #fff;
      border-radius: 15px;
      box-shadow: 0 8px 32px rgba(32, 150, 255, 0.12), 0 2px 4px rgba(5, 255, 163, 0.15);
      padding: 2.5rem 2.5rem 3rem;
      position: relative;
      text-align: center;
    }
    .avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      margin-bottom: 0.5em;
      object-fit: cover;
      box-shadow: 0 2px 16px rgba(32,150,255,0.2);
      cursor: pointer;
      border: 3px solid #2096ff;
      transition: box-shadow 0.3s ease;
      display: inline-block;
    }
    .avatar:hover {
      box-shadow: 0 0 18px 6px #05ffa3;
    }
    form {
      margin-top: 1rem;
      text-align: left;
    }
    label {
      font-weight: 500;
      color: #107978;
      margin-bottom: 0.25em;
      display: block;
    }
    input.form-control {
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 1rem;
    }
    .btn-group {
      margin-top: 1.5rem;
      display: flex;
      justify-content: space-between;
      gap: 10px;
      flex-wrap: wrap;
    }
    .btn {
      padding: 0.55rem 1.5rem;
      border-radius: 25px;
      font-weight: 600;
      letter-spacing: 0.06em;
      border: none;
      cursor: pointer;
      background: linear-gradient(120deg, #2096ff 0%, #05ffa3 100%);
      color: #fff;
      transition: box-shadow 0.3s ease, background 0.3s ease, transform 0.15s ease;
      user-select: none;
      min-width: 140px;
      text-align: center;
      box-shadow: 0 5px 15px rgba(32, 150, 255, 0.25);
      display: inline-block;
    }
    .btn:hover {
      background: linear-gradient(120deg, #05ffa3 0%, #2096ff 100%);
      box-shadow: 0 8px 20px rgba(5, 255, 163, 0.4);
      transform: scale(1.05);
    }
    .btn:active {
      transform: scale(0.98);
    }
    @media (max-width: 600px) {
      .container-profile {
        padding: 1.5rem 1rem 2rem;
      }
      .btn {
        min-width: 100%;
      }
      .btn-group {
        flex-direction: column;
      }
    }
    input[type="file"] {
      display: none;
    }
  </style>
</head>
<body>
  <main class="container-profile" role="main" aria-label="Admin Profile Setup">
    <h2>Admin Profile Setup</h2>
    <p style="color:#555; font-size:1rem; margin-bottom:1.5rem;">
      Please enter your details to complete admin setup.
    </p>

    <img
      src="img/undraw_profile.svg"
      alt="Profile Avatar"
      class="avatar"
      id="profileAvatar"
      title="Click to upload profile picture"
    />
    <input type="file" id="fileInput" accept="image/*" aria-label="Upload profile picture" />

    <form id="adminProfileForm" novalidate>
      <label for="username">Username</label>
      <input type="text" id="username" class="form-control" placeholder="Enter username" autocomplete="username" required />

      <label for="firstName">First Name</label>
      <input type="text" id="firstName" class="form-control" placeholder="Enter first name" autocomplete="given-name" required />

      <label for="lastName">Last Name</label>
      <input type="text" id="lastName" class="form-control" placeholder="Enter last name" autocomplete="family-name" required />

      <label for="email">Email Address</label>
      <input type="email" id="email" class="form-control" placeholder="Enter email address" autocomplete="email" required />

      <label for="password">Password</label>
      <input type="password" id="password" class="form-control" placeholder="Enter password" autocomplete="new-password" required />

      <label for="repeatPassword">Confirm Password</label>
      <input type="password" id="repeatPassword" class="form-control" placeholder="Confirm password" autocomplete="new-password" required />

      <div class="btn-group">
        <button type="submit" class="btn" aria-label="Save Admin Profile">Save Changes</button>
      </div>
    </form>
  </main>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js';
    import {
      getAuth,
      onAuthStateChanged,
      EmailAuthProvider,
      linkWithCredential,
      updateProfile,
      createUserWithEmailAndPassword,
      sendEmailVerification,
    } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-auth.js';
    import {
      getFirestore,
      doc,
      setDoc,
      getDoc,
      updateDoc
    } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-firestore.js';
    import {
      getStorage,
      ref as storageRef,
      uploadBytesResumable,
      getDownloadURL,
    } from 'https://www.gstatic.com/firebasejs/12.1.0/firebase-storage.js';

    // ---------- config ----------
    const firebaseConfig = {
      apiKey: "AIzaSyBu4mqM1PeTHW4AKoP3e8Nhcx4jiHtwueU",
      authDomain: "smartlux-night-light.firebaseapp.com",
      databaseURL: "https://smartlux-night-light-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "smartlux-night-light",
      storageBucket: "smartlux-night-light.firebasestorage.app",
      messagingSenderId: "558742892847",
      appId: "1:558742892847:web:30b85deeca4102cb7f71da",
      measurementId: "G-MD4BV2GWYF"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);
    const storage = getStorage(app);

    // ---------- DOM ----------
    const avatarEl = document.getElementById('profileAvatar');
    const fileInput = document.getElementById('fileInput');
    let selectedFile = null;

    avatarEl.addEventListener('click', () => fileInput.click());
    fileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (!file) return;
      if (!file.type.startsWith('image/')) {
        alert('Please choose an image file.');
        return;
      }
      selectedFile = file;
      const reader = new FileReader();
      reader.onload = (ev) => avatarEl.src = ev.target.result;
      reader.readAsDataURL(file);
    });

    const form = document.getElementById('adminProfileForm');
	const goDashboardBtn = document.getElementById('goDashboardBtn');
	
	if (goDashboardBtn) {
	  goDashboardBtn.addEventListener('click', () => {
		window.location.href = 'dashboardadmin.html';
	  });
	}


    // ---------- Auth / Firestore guard on load ----------
    let currentUser = null;
    onAuthStateChanged(auth, async (user) => {
      currentUser = user;
      if (!user) {
        console.log('No user signed in — redirecting to login.');
        location.replace('login.html');
        return;
      }

      // Prefill email from auth if present
      if (user.email) document.getElementById('email').value = user.email;

      // If a user doc already exists -> this user already solidified account -> go to profile.html
      try {
        const userDocRef = doc(db, 'users', user.uid);
        const snap = await getDoc(userDocRef);
        if (snap.exists()) {
          // user already created account — send to regular profile page
          console.log('users/{uid} exists — redirecting to profile.html');
          location.replace('profile.html');
          return;
        }
        // else: user doc does not exist, allow them to create via this admin setup form
      } catch (err) {
        console.error('Failed to check users/{uid}:', err);
        // allow user to proceed (we'll try to write later)
      }
    });

    // ---------- helper: upload avatar ----------
    async function uploadAvatarIfNeeded(uid) {
      if (!selectedFile) return null;
      const filename = `${Date.now()}_${selectedFile.name}`;
      const storagePath = `avatars/${uid}/${filename}`;
      const sRef = storageRef(storage, storagePath);
      const uploadTask = uploadBytesResumable(sRef, selectedFile);

      return await new Promise((resolve, reject) => {
        uploadTask.on('state_changed',
          null,
          (err) => reject(err),
          async () => {
            try {
              const url = await getDownloadURL(uploadTask.snapshot.ref);
              resolve(url);
            } catch (err) {
              reject(err);
            }
          }
        );
      });
    }

    // ---------- submit handler ----------
// ---------- submit handler (REPLACE your current submit handler WITH THIS) ----------
form.addEventListener('submit', async (e) => {
  e.preventDefault();

  const username = form.username.value.trim();
  const firstName = form.firstName.value.trim();
  const lastName = form.lastName.value.trim();
  const email = form.email.value.trim();
  const password = form.password.value;
  const repeatPassword = form.repeatPassword.value;

  if (!username || !firstName || !lastName || !email || !password || !repeatPassword) {
    alert('Please fill out all fields.');
    return;
  }
  if (password !== repeatPassword) {
    alert('Passwords do not match.');
    return;
  }

  try {
    // helper to write user doc and force redirect for admin
    async function writeUserAndGotoAdmin(uid, userData) {
      console.log('Writing users/{uid} for', uid, userData);
      await setDoc(doc(db, 'users', uid), userData);
      console.log('Write complete. Reading back for verification...');
      try {
        const snap = await getDoc(doc(db, 'users', uid));
        console.log('Readback snapshot:', snap.exists() ? snap.data() : '<no doc>');
        // if the doc we wrote contains role: 'admin', go to dashboardadmin
        if ((snap.exists() && (snap.data().role === 'admin')) || userData.role === 'admin') {
          // Force admin dashboard
          location.replace('dashboardadmin.html');
          return true;
        }
      } catch (readErr) {
        console.warn('Readback failed (will still redirect to admin if we just wrote it):', readErr);
        // If we just wrote role admin, still redirect
        if (userData.role === 'admin') {
          location.replace('dashboardadmin.html');
          return true;
        }
      }
      return false;
    }

    // If signed-in user is anonymous -> link credential (preserve uid)
    if (currentUser && currentUser.isAnonymous) {
      try {
        const credential = EmailAuthProvider.credential(email, password);
        const linkResult = await linkWithCredential(currentUser, credential);
        const user = linkResult.user || auth.currentUser;
        const uid = user.uid;
        console.log('Anonymous account linked. uid=', uid);

        // upload avatar if present
        let avatarUrl = null;
        if (selectedFile) avatarUrl = await uploadAvatarIfNeeded(uid);

        // update auth profile
        const profileUpdates = { displayName: username };
        if (avatarUrl) profileUpdates.photoURL = avatarUrl;
        await updateProfile(user, profileUpdates);

        // prepare Firestore payload
        const userData = {
          username,
          firstName,
          lastName,
          email,
          role: 'admin',
          createdAt: new Date()
        };
        if (avatarUrl) userData.avatarUrl = avatarUrl;

        // write and redirect to admin dashboard
        const redirected = await writeUserAndGotoAdmin(uid, userData);
        if (redirected) return;

        // fallback: if not redirected (weird), notify and go admin anyway
        alert('Account converted and saved. Redirecting to admin dashboard.');
        location.replace('dashboardadmin.html');
        return;
      } catch (linkErr) {
        console.error('linkWithCredential failed:', linkErr);
        if (linkErr && linkErr.code === 'auth/email-already-in-use') {
          alert('This email is already in use by another account. Please sign in with that account or choose a different email.');
        } else {
          alert('Could not convert temporary account: ' + (linkErr.message || linkErr));
        }
        return;
      }
    }

    // If signed-in and not anonymous -> update/create users/{uid}
    if (currentUser && !currentUser.isAnonymous) {
      const uid = currentUser.uid;
      let avatarUrl = null;
      if (selectedFile) avatarUrl = await uploadAvatarIfNeeded(uid);

      const profileUpdates = {};
      if (username) profileUpdates.displayName = username;
      if (avatarUrl) profileUpdates.photoURL = avatarUrl;
      if (Object.keys(profileUpdates).length) {
        await updateProfile(currentUser, profileUpdates);
      }

      const docPayload = {
        username,
        firstName,
        lastName,
        email,
        role: 'admin',
        updatedAt: new Date()
      };
      if (avatarUrl) docPayload.avatarUrl = avatarUrl;

      // Write the doc and force redirect to admin dashboard
      const redirected = await writeUserAndGotoAdmin(uid, docPayload);
      if (redirected) return;

      // fallback
      alert('Profile saved successfully. Redirecting to admin dashboard.');
      location.replace('dashboardadmin.html');
      return;
    }

    // No currentUser fallback: create new account then redirect
    try {
      const userCredential = await createUserWithEmailAndPassword(auth, email, password);
      const user = userCredential.user;
      const uid = user.uid;

      let avatarUrl = null;
      if (selectedFile) avatarUrl = await uploadAvatarIfNeeded(uid);

      await updateProfile(user, { displayName: username, ...(avatarUrl ? { photoURL: avatarUrl } : {}) });

      const userData = {
        username,
        firstName,
        lastName,
        email,
        role: 'admin',
        createdAt: new Date()
      };
      if (avatarUrl) userData.avatarUrl = avatarUrl;

      // write and redirect
      const redirected = await writeUserAndGotoAdmin(uid, userData);
      if (redirected) return;

      // fallback
      await sendEmailVerification(user).catch(()=>{});
      alert('Admin profile created successfully! Redirecting to admin dashboard.');
      location.replace('dashboardadmin.html');
      return;
    } catch (createErr) {
      console.error('createUser fallback failed:', createErr);
      alert('Error creating account: ' + (createErr.message || createErr));
      return;
    }

  } catch (err) {
    console.error('Saving admin profile failed:', err);
    alert('Could not save profile: ' + (err.message || err));
  }
});


  </script>
</body>
</html>
